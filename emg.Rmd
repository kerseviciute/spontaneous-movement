---
date: <small>`r Sys.Date()`</small>
author: <small>Ieva Kerseviciute</small>
---

```{r, include = FALSE}
# snakemake <- readRDS('.emg.Rmd.RDS')
library(reticulate)
library(knitr)
reticulate::use_condaenv('mne') # TODO: add PyQt5 to the environment
knitr::knit_engines$set(python = reticulate::eng_python)

scriptdir <- snakemake@scriptdir
raw_filename <- snakemake@input$raw
data_filename <- snakemake@input$data
movement_raw_filename <- snakemake@input$movement
movement_filename <- snakemake@input$movement_filtered
no_movement_filename <- snakemake@input$no_movement_filtered

config <- snakemake@config
```

---
title: '`r paste('EMG Data Processing:', snakemake@wildcards$sid, snakemake@wildcards$cell)`'
---

```{python, echo = FALSE}
import PyQt5
import pickle
import mne
import numpy as np
import pandas as pd

with open(f'{r.scriptdir}/python/methods_for_r.py', 'r') as file:
    exec(file.read())

raw = read_pickle(r.raw_filename)
data = read_pickle(r.data_filename)
movement_unfiltered = read_pickle(r.movement_raw_filename)
movement_events = read_pickle(r.movement_filename)
no_movement_events = read_pickle(r.no_movement_filename)
```

## Preprocessing

The EMG data were filtered to remove frequencies lower than `r config$filter$emg$drop_below` Hz
and higher than `r config$filter$emg$drop_above` Hz. The symmetric linear-phase FIR filter was used.

```{python, include = TRUE, echo = FALSE}
plot_all_events(raw)
```

**Figure 1.** EMG data before filtering.

```{python, include = TRUE, echo = FALSE}
plot_all_events(data)
```

**Figure 2.** EMG data after filtering.

## Movement Event Detection

```{python, include = TRUE, echo = FALSE}
plot_all_events(data, movement_unfiltered)
```

**Figure 3.** All detected movement events.

```{python, include = TRUE, echo = FALSE}
plot_all_events(data, movement_events, no_movement_events)
```

**Figure 4.** Good quality events after filtering. Good quality movement events are marked in **red**, good quality
no movement events are marked in **blue**.
